# Users, Groups and Files

## Superuser

In Linux, the administrator or privileged user is the superuser.
The superuser has the username `root` and a user ID (UID) of 0.
Some Linux distributions, such as Ubuntu, lock the root account by
default to prevent any user from logging in directly as root. This
prevents the security risks of a bug in a program or attackers
from corrupting the system due to a vulnerability being exploited
as root.

To switch to root, execute the following command:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ su
```

It starts a new shell as the target user. If the account is locked,
we cannot switch to the user. Although there are ways to unlock the
root account and enable root logins, it is NOT recommended.

Root has access to many system files and can execute special
commands that normal users are not allowed to execute. Only root
can start services at privileged ports 0-1023.

Instead of switching to root, we execute commands as root only when
it is necessary.

Prepend this command to the command we want to execute so that the
command is executed with root privileges:

```shell
sudo
```

## passwd file

The file `/etc/passwd` contains the user account information of all
users. From the manual, the format of the password file is as follows:

```
username:encrypted_password:UID:GID:comments:home_directory:shell
```

The `encrypted_password` field was previously used to store the password.
The encrypted password is now stored in the `/etc/shadow` file. An `x` in
this field indicates that the encrypted password is in the shadow file.
All users can access this file because some programs need the user account
information.

The group ID (GID) is the ID of the user's default group. The UID and
GID is usually the same number, with the group name same as the username.

The comments field includes other account information, usually the
fullname.

The shell field indicates the initial login program.

An example of the password file:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
...
```

View the whole manual:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ man 5 passwd
```

## shadow file

The `/etc/shadow` file stores password information of all user accounts.
Root privileges are needed to view this file. From the manual, the
format of the shadow file is as follows:

```
username:encrypted_password:date_of_last_password_change:min_age:max_age:warning_period:inactivity_period:account_expiration_date:reserved
```

For the `encrypted_password` field, an `!` indicates that the password is
locked. An `*` indicates that the user cannot login using a password but
may login by other means.

An example of the shadow file:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ sudo cat /etc/shadow
root:!:17093:0:99999:7:::
daemon:*:17001:0:99999:7:::
bin:*:17001:0:99999:7:::
sys:*:17001:0:99999:7:::
sync:*:17001:0:99999:7:::
...
```

View the format of the encrpted password:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ man 3 crypt
```

View the whole manual:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ man 5 passwd
```

Let's try to crack the password for the user `alice`.

The [password file][1]:

```
alice:x:1000:1000:alice,,,:/home/alice:/bin/bash
```

The [shadow file][2]:

```
alice:$6$1tMUFOTC$Hz55wORf/SpWS50S9ZGwXffcAAfeWCiT7l/WInQkIlyQ2AfOIG4bgft4ANSE8uED1D8qHpHoSx43hITBAKVei0:17228:0:99999:7:::
```

John the Ripper is a tool used to crack weak passwords on Unix,
Windows and other OS.

Install John the Ripper:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files/files$ sudo apt-get install john
```

Combine the password file and the shadow file:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files/files$ unshadow passwd shadow > mypasswd
```

Run the tool:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files/files$ john mypasswd
Loaded 1 password hash (crypt, generic crypt(3) [?/64])
Press 'q' or Ctrl-C to abort, almost any other key for status
secret           (alice)
1g 0:00:00:03 100% 2/3 0.2551g/s 239.5p/s 239.5c/s 239.5C/s 123456..pepper
Use the "--show" option to display all of the cracked passwords reliably
Session completed
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files/files$
```

## group file

The `/etc/group` file contains the all group information. From the
manual, the format of the group file is as follows:

```
group_name:encrypted_password:GID:members_username
```

An example of the group file:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ cat /etc/group
root:x:0:
daemon:x:1:
bin:x:2:
sys:x:3:
adm:x:4:syslog,ubuntu
...
```

View the whole manual:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ man 5 group
```

## Files

In Linux, directories (aka folders) and devices are treated as files.
The root directory `/` is the main directory of the file system
containing other subdirectories.

The subdirectories of the root directory includes:

- `/root`: Home directory of user `root`
- `/bin`: Common programs for system, system adminsitrator and users
- `/sbin`: Programs for system and system administrator
- `/etc`: Configuration files
- `/boot`: Startup files and kernel
- `/dev`: Devices
- `/lib`: Library files
- `/usr`: User-related programs
- `/mnt`: Mount point for external file systems
- `/var`: Variable files and temporary files created by users
- `/tmp`: Temporary files that will be deleted upon reboot
- `/home`: Home directories of users

`.` is the current directory while `..` is the parent directory.

## Environment Variables

Environment variables can affect a process. As the name suggests, it
is a part of the environment of a process.

View all environment variables:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ env
```

or:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ printenv
```

One of the most important environment variable is `PATH`. It specifies
the search path to look for the program to be executed if the program
is not built into the shell or the program was not specified with its
full path. The search stops when the program name is found in a
directory specified and the program is executed.

View the value of the `PATH` environment variable:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ printenv PATH
```

or:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ echo $PATH
```

An attacker may store a malicious program in a directory at the start
of the search path and masquerades itself as a common program used by
many users.

Let's try to masquerade as a `ls` command.

Locate the full path of `ls`:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ which ls
/bin/ls
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$
```

Using a simple [binary][3] with the following [source code][4]:

```c
#include <stdio.h>

int main(int argc, char** argv) {
    int i;

    for (i = 1; i < argc; i++) {
        printf("%s  ", argv[i]);
    }

    printf("\n");

    return 0;
}
```

Compile the binary:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ gcc -o ls ls.c
```

Temporarily prepend the directory to the search path:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ PATH="/vagrant/lessons/1_users_groups_files/build:$PATH"
```

or permanently prepend the directory to the search path:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files$ export PATH=/vagrant/lessons/1_users_groups_files/build:$PATH
```

or store the binary in one of the directory in the search path
before the directory `/bin` since the actual full path of `ls`
is `/bin/ls`.

Try executing the command `ls`. Is the command executed the actual
command the user wanted?

Verify that the location of `ls` is the location of our binary:

```shell
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files/build$ which ls
/vagrant/lessons/1_users_groups_files/build/ls
ubuntu@ubuntu-xenial:/vagrant/lessons/1_users_groups_files/build$
```

[1]: ./files/passwd
[2]: ./files/shadow
[3]: ./build/ls
[4]: ./src/ls.c